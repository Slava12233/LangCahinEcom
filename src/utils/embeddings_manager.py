"""
מודול לניהול embeddings באמצעות sentence-transformers.
מאפשר חיפוש סמנטי בשאלות נפוצות.
"""

import logging
import numpy as np
from typing import Dict, List, Tuple, Any, Optional
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
from utils import get_logger

logger = get_logger(__name__)

class EmbeddingsManager:
    def __init__(self, threshold: float = 0.7):
        """
        אתחול מנהל ה-embeddings
        
        Args:
            threshold: סף דמיון מינימלי לחיפוש שאלות דומות
        """
        try:
            self.model = SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')
            self.threshold = threshold
            logger.info("מודל sentence-transformers נטען בהצלחה")
        except Exception as e:
            logger.error(f"שגיאה בטעינת מודל sentence-transformers: {e}")
            raise

        # FAQ מורחב עם קטגוריות
        self.faq_data = {
            # קטגוריה: מוצרים ומלאי - שאלות בסיסיות
            "איך אני יכול להוסיף מוצר חדש לחנות?": """
            **אפשרות ידנית:**
            1. היכנס לפאנל וורדפרס > מוצרים > הוסף חדש
            2. מלא את פרטי המוצר (שם, תיאור, מחיר, מלאי)
            3. הוסף תמונות ושמור
            
            **אוטומציה באמצעות הסוכן:**
            פשוט בקש מהסוכן: "צור מוצר חדש בשם X, מחיר Y, כמות במלאי Z"
            לדוגמה: "צור מוצר חדש בשם 'חולצת כותנה', מחיר 99.90 ש״ח, כמות במלאי 50"
            """,
            
            # קטגוריה: מוצרים ומלאי - וריאציות מוצרים
            "איך אני יכול להוסיף וריאציות למוצר?": """
            **אפשרות ידנית:**
            1. ערוך את המוצר
            2. תחת 'נתוני מוצר' בחר 'מוצר משתנה'
            3. הוסף תכונות (צבע, מידה וכו')
            4. צור וריאציות והגדר מחיר ומלאי לכל אחת
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף וריאציות למוצר X עם התכונות הבאות: [פירוט]"
            לדוגמה: "הוסף וריאציות לחולצה: צבעים - שחור, לבן, אדום; מידות - S,M,L,XL"
            """,

            "איך אני יכול לנהל מחירונים שונים?": """
            **אפשרות ידנית:**
            1. היכנס להגדרות WooCommerce > מחירונים
            2. צור מחירון חדש (סיטונאי, VIP וכו')
            3. הגדר כללי תמחור ותנאים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור מחירון חדש בשם X עם Y% הנחה" או
            "עדכן מחירים במחירון סיטונאי"
            """,

            "איך אני יכול לארגן את המוצרים בקטגוריות?": """
            **אפשרות ידנית:**
            1. היכנס למוצרים > קטגוריות
            2. צור מבנה היררכי של קטגוריות
            3. הוסף תיאורים ותמונות לקטגוריות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור קטגוריה חדשה בשם X" או
            "העבר את כל המוצרים מקטגוריה X לקטגוריה Y"
            """,

            "איך אני יכול לנהל תמונות מוצרים?": """
            **אפשרות ידנית:**
            1. בעריכת מוצר, לחץ על 'הוסף מדיה'
            2. העלה תמונות באיכות גבוהה
            3. הגדר תמונה ראשית ותמונות גלריה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "עדכן תמונות למוצר X" או
            "אופטמז את כל תמונות המוצרים"
            """,

            "איך אני יכול למכור מוצרים דיגיטליים?": """
            **אפשרות ידנית:**
            1. צור מוצר חדש וסמן כ'מוצר דיגיטלי'
            2. העלה את הקובץ להורדה
            3. הגדר הגבלות הורדה ותוקף
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף מוצר דיגיטלי חדש" או
            "עדכן קובץ הורדה למוצר X"
            """,

            "איך אני יכול לנהל מבצעים והנחות על מוצרים?": """
            **אפשרות ידנית:**
            1. בחר מוצרים להנחה
            2. הגדר מחיר מבצע ותאריכי תוקף
            3. הגדר כללי הנחה מיוחדים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור מבצע X% הנחה על קטגוריה Y" או
            "הגדר מחיר מבצע למוצר Z"
            """,

            "איך אני יכול לייבא/לייצא רשימת מוצרים?": """
            **אפשרות ידנית:**
            1. היכנס לכלים > ייבוא/ייצוא
            2. בחר פורמט (CSV/XML)
            3. התאם שדות ובצע ייבוא/ייצוא
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "ייבא מוצרים מקובץ X" או
            "ייצא רשימת מוצרים לאקסל"
            """,

            "איך אני יכול לנהל מלאי בין סניפים שונים?": """
            **אפשרות ידנית:**
            1. התקן תוסף ניהול מלאי מרובה סניפים
            2. הגדר סניפים ומחסנים
            3. נהל מלאי לכל סניף בנפרד
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "העבר מלאי מסניף X לסניף Y" או
            "הצג מצב מלאי בכל הסניפים"
            """,

            "איך אני יכול להגדיר התראות מלאי?": """
            **אפשרות ידנית:**
            1. היכנס להגדרות WooCommerce > מוצרים
            2. הגדר סף מלאי נמוך
            3. קבע נמענים להתראות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הגדר התראת מלאי נמוך ל-X יחידות" או
            "שלח לי התראה כשמוצר Y אוזל"
            """,

            # קטגוריה: שיווק וקידום
            "איך אני יכול ליצור קופון הנחה?": """
            **אפשרות ידנית:**
            1. היכנס לפאנל וורדפרס > שיווק > קופונים
            2. הגדר את פרטי הקופון (קוד, סכום/אחוז הנחה)
            3. הגדר תנאי שימוש ותוקף
            
            **אוטומציה באמצעות הסוכן:**
            פשוט בקש: "צור קופון הנחה של X אחוז" או
            "צור קופון בשווי X ש״ח שתקף עד תאריך Y"
            """,

            "איך אני יכול לקדם את החנות בגוגל?": """
            **אפשרות ידנית:**
            1. הגדר חשבון Google Ads
            2. צור קמפיינים ממוקדים
            3. הגדר תקציב ומילות מפתח
            4. עקוב אחר ביצועים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור קמפיין גוגל למוצר X" או
            "נתח ביצועי קמפיין Y"
            """,

            "איך אני יכול לשפר את ה-SEO של החנות?": """
            **אפשרות ידנית:**
            1. התקן תוסף SEO (כמו Yoast)
            2. אופטמז כותרות ותיאורים
            3. הוסף תגיות meta
            4. שפר מהירות אתר
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "אופטמז SEO למוצר X" או
            "בדוק דירוג מילות מפתח"
            """,

            "איך אני יכול לנהל רשימת תפוצה?": """
            **אפשרות ידנית:**
            1. חבר מערכת דיוור (MailChimp וכו')
            2. צור טפסי הרשמה
            3. תכנן קמפיינים אוטומטיים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "שלח ניוזלטר לרשימה X" או
            "צור קמפיין דיוור אוטומטי"
            """,

            "איך אני יכול לנהל תוכנית נאמנות?": """
            **אפשרות ידנית:**
            1. התקן תוסף נקודות/הטבות
            2. הגדר כללי צבירה ומימוש
            3. צור רמות חברות שונות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור מבצע נקודות כפול" או
            "שדרג לקוח X לרמת VIP"
            """,

            "איך אני יכול לנהל שיתופי פעולה עם משפיענים?": """
            **אפשרות ידנית:**
            1. זהה משפיענים רלוונטיים
            2. צור קופונים ייחודיים
            3. עקוב אחר ביצועים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור קוד קופון למשפיען X" או
            "נתח ביצועי שיתוף פעולה Y"
            """,

            "איך אני יכול לנהל קמפיין רימרקטינג?": """
            **אפשרות ידנית:**
            1. התקן פיקסל מעקב
            2. הגדר קהלים
            3. צור מודעות מותאמות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור קמפיין רימרקטינג לקטגוריה X" או
            "עדכן קהלי רימרקטינג"
            """,

            "איך אני יכול לנהל דפי נחיתה?": """
            **אפשרות ידנית:**
            1. צור דף נחיתה ייעודי
            2. אופטמז לקונברסיה
            3. בצע A/B Testing
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור דף נחיתה למוצר X" או
            "נתח ביצועי דף נחיתה Y"
            """,

            "איך אני יכול לנהל מבצעי חג?": """
            **אפשרות ידנית:**
            1. תכנן מבצעים מראש
            2. הכן באנרים ותוכן
            3. הגדר הנחות אוטומטיות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור מבצע חג למוצרים X" או
            "תזמן קמפיין לחג Y"
            """,

            "איך אני יכול לנהל תוכן שיווקי?": """
            **אפשרות ידנית:**
            1. צור לוח תוכן
            2. כתוב פוסטים ומאמרים
            3. שתף ברשתות חברתיות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור תוכנית תוכן חודשית" או
            "כתוב פוסט על מוצר X"
            """,

            # קטגוריה: הזמנות ומשלוחים
            "איך אני יכול לעקוב אחר הזמנות?": """
            **אפשרות ידנית:**
            1. היכנס לפאנל וורדפרס > הזמנות
            2. סנן לפי סטטוס או תאריך
            3. צפה בפרטי ההזמנה המלאים
            
            **אוטומציה באמצעות הסוכן:**
            בקש מהסוכן:
            - "הצג הזמנות מהיום"
            - "מה הסטטוס של הזמנה מספר X"
            - "כמה הזמנות ממתינות למשלוח?"
            """,

            "איך אני יכול לטפל בהחזרות ובביטולים?": """
            **אפשרות ידנית:**
            1. אתר את ההזמנה הרלוונטית
            2. שנה סטטוס להחזרה/ביטול
            3. טפל בהחזר כספי
            4. עדכן מלאי בהתאם
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "טפל בהחזרה של הזמנה X" או
            "בטל הזמנה Y וטפל בהחזר כספי"
            """,

            "איך אני יכול להגדיר אזורי משלוח ומחירים?": """
            **אפשרות ידנית:**
            1. היכנס להגדרות WooCommerce > משלוח
            2. הגדר אזורי משלוח
            3. קבע שיטות משלוח ומחירים לכל אזור
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף אזור משלוח חדש" או
            "עדכן מחירי משלוח לאזור X"
            """,

            "איך אני יכול לחבר חברת שילוח לחנות?": """
            **אפשרות ידנית:**
            1. התקן תוסף של חברת השילוח
            2. הגדר פרטי התחברות
            3. קבע הגדרות שילוח אוטומטי
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "חבר את חברת השילוח X" או
            "הגדר שילוח אוטומטי עם חברה Y"
            """,

            "איך אני יכול להדפיס תוויות משלוח?": """
            **אפשרות ידנית:**
            1. בחר הזמנות להדפסה
            2. הפק תוויות משלוח
            3. שלח לחברת השילוח
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הדפס תוויות משלוח להזמנות מהיום" או
            "הכן תוויות משלוח להזמנות ממתינות"
            """,

            "איך אני יכול לעקוב אחר משלוחים?": """
            **אפשרות ידנית:**
            1. היכנס למערכת חברת השילוח
            2. הזן מספר מעקב
            3. בדוק סטטוס משלוח
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "מה הסטטוס של משלוח X" או
            "עדכן אוטומטית סטטוס משלוחים"
            """,

            "איך אני יכול לנהל משלוחים בינלאומיים?": """
            **אפשרות ידנית:**
            1. הגדר אזורי משלוח בינלאומיים
            2. קבע מחירי משלוח לפי מדינה
            3. הגדר מסמכי יצוא ומכס
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הגדר משלוח למדינה X" או
            "חשב עלויות משלוח בינלאומי"
            """,

            "איך אני יכול לטפל בהזמנות דחופות?": """
            **אפשרות ידנית:**
            1. סמן הזמנות כדחופות
            2. תעדף בתור המשלוחים
            3. בחר שירות משלוח מהיר
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "סמן הזמנה X כדחופה" או
            "הצג את כל ההזמנות הדחופות"
            """,

            "איך אני יכול לנהל איסוף עצמי?": """
            **אפשרות ידנית:**
            1. הגדר נקודות איסוף
            2. קבע שעות פעילות
            3. נהל תורים לאיסוף
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף נקודת איסוף חדשה" או
            "הצג הזמנות לאיסוף היום"
            """,

            "איך אני יכול לטפל בבעיות משלוח?": """
            **אפשרות ידנית:**
            1. זהה את הבעיה (איחור, נזק, אבדן)
            2. פתח פנייה בחברת השילוח
            3. עדכן את הלקוח
            4. טפל בפיצוי במידת הצורך
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "דווח על בעיה במשלוח X" או
            "עקוב אחר טיפול בבעיות משלוח"
            """,

            # קטגוריה: שירות לקוחות
            "איך אני יכול לשפר את חווית הלקוח?": """
            **המלצות לשיפור השירות:**
            1. מענה מהיר לפניות
            2. מדיניות החזרות ברורה
            3. תמיכה במגוון אמצעי תשלום
            4. משלוח מהיר ואמין
            
            **אוטומציה באמצעות הסוכן:**
            הסוכן יכול לעזור ב:
            - "צור דוח שביעות רצון לקוחות"
            - "נתח זמני תגובה לפניות"
            - "הצג המלצות לשיפור השירות"
            """,

            # קטגוריה: דוחות וניתוח נתונים
            "איך אני יכול לנתח את ביצועי החנות?": """
            **כלים לניתוח ביצועים:**
            1. Google Analytics
            2. דוחות WooCommerce מובנים
            3. כלי מעקב המרות
            4. ניתוח התנהגות לקוחות
            
            **אוטומציה באמצעות הסוכן:**
            בקש מהסוכן:
            - "הכן דוח מכירות חודשי"
            - "הצג מוצרים הכי נמכרים"
            - "נתח מגמות מכירה"
            """,

            # קטגוריה: יכולות הסוכן
            "מה הסוכן יכול לעשות עבורי?": """
            **יכולות עיקריות של הסוכן:**
            1. ניהול מוצרים ומלאי:
               - יצירה ועדכון מוצרים
               - ניהול מלאי אוטומטי
            
            2. ניהול הזמנות:
               - מעקב אחר הזמנות
               - עדכון סטטוס משלוחים
            
            3. שיווק וקידום:
               - יצירת קופונים
               - ניהול מבצעים
            
            4. דוחות וניתוח:
               - דוחות מכירות
               - ניתוח מגמות
            
            פשוט כתוב לסוכן בשפה טבעית מה אתה רוצה שיעשה!
            """,

            "איך אני יכול לבקש מהסוכן לבצע פעולה?": """
            **עקרונות לתקשורת יעילה עם הסוכן:**
            
            1. היה ספציפי וברור:
               ✓ "צור מוצר חדש בשם X במחיר Y"
               ✗ "אני רוצה להוסיף משהו"
            
            2. ציין פרטים חשובים:
               ✓ "צור קופון 20% שתקף עד 31.12"
               ✗ "תכין לי קופון"
            
            3. אם לא בטוח, שאל:
               "מה הפעולות שאתה יכול לבצע בנושא X?"
            
            הסוכן תמיד יבקש הבהרות אם משהו לא ברור!
            """,

            # קטגוריה: ניהול כספים
            "איך אני יכול לנהל את הכספים של החנות?": """
            **אפשרות ידנית:**
            1. עקוב אחר הכנסות והוצאות
            2. נהל תזרים מזומנים
            3. הפק דוחות תקופתיים
            4. תכנן תקציב
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הצג דוח הכנסות חודשי" או
            "חשב רווחיות לפי קטגוריות"
            """,

            "איך אני יכול להגדיר אמצעי תשלום?": """
            **אפשרות ידנית:**
            1. היכנס להגדרות WooCommerce > תשלומים
            2. הפעל/כבה שיטות תשלום
            3. הגדר פרטי חיבור לסליקה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף אמצעי תשלום חדש" או
            "בדוק סטטוס חיבור לסולק"
            """,

            "איך אני יכול לנהל החזרים וזיכויים?": """
            **אפשרות ידנית:**
            1. אתר את ההזמנה הרלוונטית
            2. בצע החזר מלא/חלקי
            3. תעד את סיבת ההחזר
            4. עדכן את הלקוח
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בצע החזר להזמנה X" או
            "הפק דוח החזרים חודשי"
            """,

            "איך אני יכול לנהל מיסים וחשבוניות?": """
            **אפשרות ידנית:**
            1. הגדר הגדרות מע"מ
            2. קבע כללי מיסוי לפי אזור
            3. הפק חשבוניות אוטומטית
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "עדכן שיעור מע\"מ" או
            "הפק דוח חשבוניות חודשי"
            """,

            "איך אני יכול לנהל תמחור דינמי?": """
            **אפשרות ידנית:**
            1. הגדר כללי תמחור אוטומטי
            2. קבע טווחי מחירים
            3. הגדר תנאים לשינוי מחיר
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "עדכן מחירים לפי ביקוש" או
            "הפעל תמחור דינמי בקטגוריה X"
            """,

            "איך אני יכול לנהל עמלות ותשלומים לספקים?": """
            **אפשרות ידנית:**
            1. תעד עמלות וחיובים
            2. נהל תשלומים לספקים
            3. עקוב אחר מועדי תשלום
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "חשב עמלות לספק X" או
            "הכן דוח תשלומים לספקים"
            """,

            "איך אני יכול לנהל תקציב שיווק?": """
            **אפשרות ידנית:**
            1. הגדר תקציב חודשי
            2. חלק לערוצי שיווק
            3. עקוב אחר ROI
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "נתח ROI של קמפיין X" או
            "עדכן תקציב שיווק חודשי"
            """,

            "איך אני יכול לנהל הלוואות ומימון?": """
            **אפשרות ידנית:**
            1. תעד הלוואות וחיובים
            2. נהל לוח סילוקין
            3. חשב כדאיות מימון
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "חשב החזר חודשי להלוואה" או
            "הצג מצב הלוואות פעילות"
            """,

            "איך אני יכול לנהל ביטוחים ואחריות?": """
            **אפשרות ידנית:**
            1. תעד פוליסות ביטוח
            2. נהל תביעות ואחריות
            3. חדש ביטוחים בזמן
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק תוקף ביטוח X" או
            "הפק דוח תביעות אחריות"
            """,

            "איך אני יכול לנהל דוחות רווח והפסד?": """
            **אפשרות ידנית:**
            1. אסוף נתוני הכנסות והוצאות
            2. חשב רווח גולמי ונקי
            3. נתח מגמות ומדדים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הפק דוח רווח והפסד חודשי" או
            "נתח מגמות רווחיות שנתית"
            """,

            # קטגוריה: אבטחה ותחזוקה
            "איך אני יכול לאבטח את החנות?": """
            **אפשרות ידנית:**
            1. התקן תוספי אבטחה
            2. עדכן סיסמאות באופן קבוע
            3. הגדר SSL ו-HTTPS
            4. בצע סריקות אבטחה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בצע סריקת אבטחה" או
            "עדכן את כל התוספים"
            """,

            "איך אני יכול לגבות את החנות?": """
            **אפשרות ידנית:**
            1. הגדר גיבויים אוטומטיים
            2. בחר מיקום אחסון מאובטח
            3. בדוק תקינות גיבויים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בצע גיבוי מיידי" או
            "בדוק סטטוס גיבוי אחרון"
            """,

            "איך אני יכול לנהל הרשאות משתמשים?": """
            **אפשרות ידנית:**
            1. צור תפקידים והרשאות
            2. הקצה הרשאות למשתמשים
            3. נהל גישה למערכת
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הוסף משתמש חדש עם הרשאות X" או
            "בדוק הרשאות משתמש Y"
            """,

            "איך אני יכול לעמוד בדרישות GDPR?": """
            **אפשרות ידנית:**
            1. עדכן מדיניות פרטיות
            2. הוסף טפסי הסכמה
            3. אפשר ייצוא/מחיקת מידע
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "ייצא מידע ללקוח X" או
            "מחק מידע של לקוח Y"
            """,

            "איך אני יכול לנטר ביצועי אתר?": """
            **אפשרות ידנית:**
            1. התקן כלי ניטור
            2. בדוק זמני טעינה
            3. נטר שגיאות ותקלות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק ביצועי אתר" או
            "הצג דוח שגיאות שבועי"
            """,

            "איך אני יכול לעדכן את המערכת והתוספים?": """
            **אפשרות ידנית:**
            1. בדוק עדכונים זמינים
            2. גבה לפני עדכון
            3. בצע עדכונים בסביבת בדיקות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק עדכונים זמינים" או
            "עדכן את כל התוספים"
            """,

            "איך אני יכול להגן מפני הונאות?": """
            **אפשרות ידנית:**
            1. הגדר כללי אימות הזמנות
            2. בדוק הזמנות חשודות
            3. הגדר מגבלות קופונים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק הזמנה חשודה X" או
            "הפעל הגנת הונאות מתקדמת"
            """,

            "איך אני יכול לנהל לוגים ותיעוד?": """
            **אפשרות ידנית:**
            1. הגדר רמות תיעוד
            2. בדוק לוגים באופן קבוע
            3. שמור היסטוריית פעולות
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "הצג לוגים מהיום" או
            "חפש פעולות של משתמש X"
            """,

            "איך אני יכול לנהל גרסאות קוד?": """
            **אפשרות ידנית:**
            1. השתמש במערכת גרסאות
            2. תעד שינויים
            3. שמור גיבויי קוד
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בצע גיבוי קוד" או
            "שחזר לגרסה קודמת"
            """,

            "איך אני יכול לנהל תעודות SSL?": """
            **אפשרות ידנית:**
            1. התקן תעודת SSL
            2. חדש תעודות בזמן
            3. בדוק תקינות HTTPS
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק תוקף SSL" או
            "חדש תעודת SSL"
            """,

            # קטגוריה: אופטימיזציה וביצועים
            "איך אני יכול לשפר את מהירות האתר?": """
            **אפשרות ידנית:**
            1. אופטמז תמונות
            2. הפעל מטמון (Cache)
            3. השתמש ב-CDN
            4. נקה את בסיס הנתונים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "אופטמז תמונות בחנות" או
            "נקה מטמון ובסיס נתונים"
            """,

            "איך אני יכול לשפר את חווית המשתמש?": """
            **אפשרות ידנית:**
            1. פשט את תהליך הרכישה
            2. שפר ניווט באתר
            3. הוסף חיפוש חכם
            4. אופטמז טפסים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "נתח התנהגות משתמשים" או
            "בדוק נקודות נטישה"
            """,

            "איך אני יכול להתאים את האתר למובייל?": """
            **אפשרות ידנית:**
            1. בדוק תצוגה במכשירים שונים
            2. אופטמז תמונות למובייל
            3. פשט ניווט למסך קטן
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק תאימות מובייל" או
            "אופטמז תצוגה למובייל"
            """,

            "איך אני יכול לשפר את שיעור ההמרה?": """
            **אפשרות ידנית:**
            1. נתח משפך המרה
            2. זהה נקודות כאב
            3. בצע A/B Testing
            4. שפר קריאות לפעולה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "נתח שיעורי המרה" או
            "הצע שיפורים להמרה"
            """,

            "איך אני יכול לבצע A/B Testing?": """
            **אפשרות ידנית:**
            1. הגדר גרסאות לבדיקה
            2. קבע מדדי הצלחה
            3. נתח תוצאות
            4. יישם שינויים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "צור בדיקת A/B לדף X" או
            "נתח תוצאות בדיקה Y"
            """,

            "איך אני יכול לשפר את הנראות בחיפוש?": """
            **אפשרות ידנית:**
            1. אופטמז כותרות ותיאורים
            2. שפר מבנה URL
            3. הוסף Schema Markup
            4. שפר מהירות טעינה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק דירוג בגוגל" או
            "אופטמז תוכן לחיפוש"
            """,

            "איך אני יכול לשפר את הנגישות?": """
            **אפשרות ידנית:**
            1. הוסף תיאורי תמונות
            2. שפר ניגודיות צבעים
            3. אפשר ניווט מקלדת
            4. הוסף כתוביות לוידאו
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק תאימות נגישות" או
            "שפר נגישות בדף X"
            """,

            "איך אני יכול לנטר ביצועי שרת?": """
            **אפשרות ידנית:**
            1. בדוק שימוש במשאבים
            2. נטר זמני תגובה
            3. זהה צווארי בקבוק
            4. אופטמז בסיס נתונים
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק ביצועי שרת" או
            "אופטמז שימוש במשאבים"
            """,

            "איך אני יכול לשפר את אבטחת המידע?": """
            **אפשרות ידנית:**
            1. עדכן תוכנות וסיסמאות
            2. הצפן תעבורה ומידע
            3. הגבל גישות
            4. בצע סריקות אבטחה
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בצע סריקת אבטחה" או
            "עדכן הגדרות אבטחה"
            """,

            "איך אני יכול לשפר את זמני הטעינה?": """
            **אפשרות ידנית:**
            1. דחס קבצים
            2. אופטמז תמונות
            3. השתמש ב-Lazy Loading
            4. מטמן תוכן סטטי
            
            **אוטומציה באמצעות הסוכן:**
            בקש: "בדוק זמני טעינה" או
            "אופטמז ביצועי אתר"
            """,
        }
        
        # חישוב embeddings לכל השאלות
        self._calculate_faq_embeddings()
        
        logger.info(
            "מנהל embeddings אותחל",
            extra={"faq_count": len(self.faq_data)}
        )

    def _calculate_faq_embeddings(self) -> None:
        """חישוב embeddings לכל השאלות ב-FAQ"""
        try:
            self.faq_questions = list(self.faq_data.keys())
            # חישוב embeddings כמערך numpy ישירות
            self.faq_embeddings = self.model.encode(self.faq_questions, convert_to_numpy=True)
            logger.info("חושבו embeddings לשאלות ה-FAQ")
        except Exception as e:
            logger.error(f"שגיאה בחישוב embeddings ל-FAQ: {e}")
            raise

    def find_similar_questions(self, query: str, threshold: Optional[float] = None) -> List[Tuple[str, str, float]]:
        """חיפוש שאלות דומות מה-FAQ באמצעות דמיון קוסינוס.
        
        Args:
            query: שאלת המשתמש לחיפוש
            threshold: סף דמיון מינימלי (אופציונלי, ברירת מחדל מה-__init__)
            
        Returns:
            רשימת טאפלים (שאלה, תשובה, ציון) מעל הסף
        """
        try:
            # שימוש בסף מה-__init__ אם לא הועבר אחר
            threshold = threshold if threshold is not None else self.threshold
            
            # חישוב embedding לשאלת המשתמש
            query_embedding = self.model.encode(query, convert_to_numpy=True)
            
            # חישוב דמיון קוסינוס
            similarities = cosine_similarity(
                query_embedding.reshape(1, -1),
                self.faq_embeddings
            )[0]
            
            # איסוף התאמות מעל הסף
            matches = []
            for i, score in enumerate(similarities):
                if score >= threshold:
                    question = self.faq_questions[i]
                    answer = self.faq_data[question]
                    matches.append((question, answer, float(score)))
            
            # מיון לפי ציון דמיון
            matches.sort(key=lambda x: x[2], reverse=True)
            
            logger.info(
                "נמצאו התאמות לשאלה",
                extra={
                    "query": query,
                    "matches_count": len(matches),
                    "threshold": threshold,
                    "top_score": matches[0][2] if matches else 0
                }
            )
            
            return matches
            
        except Exception as e:
            logger.error(
                "שגיאה בחיפוש שאלות דומות",
                extra={
                    "error": str(e),
                    "query": query,
                    "threshold": threshold
                }
            )
            raise

    def _calculate_similarity(self, vec1: List[float], vec2: List[float]) -> float:
        """חישוב דמיון קוסינוס בין שני וקטורים"""
        try:
            vec1_np = np.array(vec1)
            vec2_np = np.array(vec2)
            return float(np.dot(vec1_np, vec2_np) / (np.linalg.norm(vec1_np) * np.linalg.norm(vec2_np)))
        except Exception as e:
            logger.error(
                "שגיאה בחישוב דמיון",
                extra={"error": str(e)}
            )
            return 0.0

    def add_faq(self, question: str, answer: str) -> bool:
        """
        הוספת שאלה ותשובה חדשות ל-FAQ
        
        Args:
            question: השאלה החדשה
            answer: התשובה לשאלה
            
        Returns:
            האם ההוספה הצליחה
        """
        try:
            # בדיקה אם השאלה כבר קיימת
            if question in self.faq_data:
                logger.warning(
                    "שאלה כבר קיימת ב-FAQ",
                    extra={"question": question}
                )
                return False
            
            # חישוב embedding לשאלה החדשה
            embedding = self.model.encode(question, convert_to_numpy=True)
            
            # הוספה למאגר
            self.faq_data[question] = answer
            
            logger.info(
                "נוספה שאלה חדשה ל-FAQ",
                extra={
                    "question": question,
                    "answer_length": len(answer)
                }
            )
            
            return True
            
        except Exception as e:
            logger.error(
                "שגיאה בהוספת שאלה ל-FAQ",
                extra={
                    "error": str(e),
                    "question": question
                }
            )
            return False

    def get_faq_stats(self) -> Dict[str, Any]:
        """
        קבלת סטטיסטיקות על מאגר השאלות הנפוצות
        
        Returns:
            מילון עם סטטיסטיקות שונות
        """
        try:
            # חישוב מטריקת דמיון ממוצעת בין כל זוגות השאלות
            questions = list(self.faq_data.keys())
            embeddings = np.array([self.faq_embeddings[i] for i in range(len(questions))])
            
            similarities = np.dot(embeddings, embeddings.T) / (
                np.linalg.norm(embeddings, axis=1)[:, np.newaxis] * 
                np.linalg.norm(embeddings, axis=1)[np.newaxis, :]
            )
            
            # הורדת האלכסון (דמיון של שאלה לעצמה)
            np.fill_diagonal(similarities, 0)
            avg_similarity = np.mean(similarities)
            
            stats = {
                "total_questions": len(self.faq_data),
                "avg_question_length": np.mean([len(q) for q in questions]),
                "avg_answer_length": np.mean([len(a) for a in self.faq_data.values()]),
                "avg_similarity": float(avg_similarity),
                "embedding_dim": len(next(iter(self.faq_embeddings))),
                "categories": self._analyze_categories()
            }
            
            logger.info(
                "סטטיסטיקות FAQ",
                extra=stats
            )
            
            return stats
            
        except Exception as e:
            logger.error(
                "שגיאה בחישוב סטטיסטיקות FAQ",
                extra={"error": str(e)}
            )
            return {"error": str(e)}

    def _analyze_categories(self) -> Dict[str, int]:
        """
        ניתוח קטגוריות השאלות לפי מילות מפתח
        """
        categories = {
            "מוצרים ומלאי": [
                "מוצר", "פריט", "מלאי", "הוספה", "מחיר", 
                "עדכון", "מחירים", "כמות", "פריטים"
            ],
            "שיווק וקידום": [
                "קידום", "שיווק", "פרסום", "קמפיין", "מבצע",
                "הנחה", "קופון", "רשתות חברתיות", "פייסבוק"
            ],
            "הזמנות ומשלוחים": [
                "הזמנה", "משלוח", "סטטוס", "מעקב", "החזרה",
                "ביטול", "משלוחים", "הובלה"
            ],
            "שירות לקוחות": [
                "שירות", "לקוח", "פניה", "תמיכה", "החזרות",
                "זמני תגובה", "שביעות רצון"
            ],
            "דוחות וניתוח": [
                "דוח", "ניתוח", "סטטיסטיקה", "ביצועים", "מכירות",
                "אנליטיקס", "מגמות", "נתונים"
            ],
            "יכולות הסוכן": [
                "סוכן", "אוטומציה", "אוטומטי", "בקשה", "פעולה",
                "יכולת", "אפשרות"
            ]
        }
        
        result = {cat: 0 for cat in categories}
        
        for question in self.faq_data:
            question_lower = question.lower()
            for category, keywords in categories.items():
                if any(keyword in question_lower for keyword in keywords):
                    result[category] += 1
                    
            # בדיקת התשובה גם כן
            answer = self.faq_data[question].lower()
            for category, keywords in categories.items():
                if any(keyword in answer for keyword in keywords):
                    result[category] += 1
        
        return result 